<script setup>
import L from "leaflet";
import "leaflet/dist/leaflet.css";
import { areaList } from "@/lib/areaCode";
import { useMapStore } from "@/stores";
import { BASE_MAP_TILES_URL } from "@/const";
import { storeToRefs } from "pinia";
import {
  flattenTree,
  getAreaFullPath,
  getLayerByName,
  getWrappedUrlByLayerType,
} from "@/util/index";
import { ElMessage } from "element-plus";

const flatAreaList = flattenTree(areaList);

const mapStore = useMapStore();
const { areaCode, geoJson } = storeToRefs(mapStore);

const zoom = ref([1, 10]);
const isDownloading = ref(false);
const activeJob = ref(null);

// 进度统计
const completedTiles = ref(0);
const successCount = ref(0);
const failCount = ref(0);
const skipCount = ref(0);
const progressValue = ref(0);
const progressMax = ref(100);

onMounted(() => {
  // 设置事件监听
  window.electronAPI?.onTileProgress(handleTileProgress);
  //监听任务创建
  window.electronAPI?.onJobCreated((job) => {
    activeJob.value = job;
  });
  window.electronAPI?.onJobUpdate(handleJobUpdate);
});

async function downloadTiles() {
  if (!geoJson.value) {
    ElMessage.error("请先选择区域");
    return;
  }
  const visibleLayers = mapStore.visibleLayerName;
  if (!visibleLayers.length) {
    ElMessage.error("请先选择图层");
    return;
  }
  if (visibleLayers.length > 1) {
    ElMessage.error("一次只能下载一种类型的底图");
    return;
  }
  if (!storagePath.value) {
    ElMessage.error("请先选择存储目录");
    return;
  }

  const layer = getLayerByName(visibleLayers[0]);
  const { urlTemplate, subdomains } = getWrappedUrlByLayerType(
    layer.url,
    layer.type
  );
  const bounds = L.geoJSON(geoJson.value).getBounds();
  isDownloading.value = true;

  try {
    const job = await window.electronAPI.downloadArea({
      bounds: [
        bounds.getSouthWest().lat,
        bounds.getSouthWest().lng,
        bounds.getNorthEast().lat,
        bounds.getNorthEast().lng,
      ],
      minZoom: zoom.value[0],
      maxZoom: zoom.value[1],
      urlTemplate: urlTemplate,
      subdomains,
      storagePath: storagePath.value,
    });

    console.log("🚀 ~ downloadTiles ~ job:", job);

    activeJob.value = {
      id: job.id,
      status: "queued",
      tiles: job.tiles,
    };

    // 重置计数器
    completedTiles.value = 0;
    successCount.value = 0;
    failCount.value = 0;
    skipCount.value = 0;
    progressMax.value = job.tiles?.length;
    progressValue.value = 0;
  } catch (error) {
    console.error("启动下载失败:", error);
    alert(`下载失败: ${error.message}`);
  } finally {
    isDownloading.value = false;
  }
}

function handleTileProgress(data) {
  console.log("🚀 ~ handleTileProgress ~ data:", data);

  // 更新进度条
  progressValue.value = completedTiles.value;
}

function handleJobUpdate(update) {
  if (update.jobId === activeJob.value?.id) {
    activeJob.value.status = update.status;
    // 可以添加更详细的更新处理
  }
}

const cascaderProps = {
  children: "children",
  label: "chnName",
  value: "code",
  checkStrictly: true,
};
const areaRef = ref(null);

const getAreaCode = ref([]);

watch(
  () => areaCode.value,
  (newCode, oldCode) => {
    const result = getAreaFullPath(flatAreaList, newCode);
    getAreaCode.value = result;
  },
  { immediate: true }
);

const handleChangeCode = (value) => {
  const code = value[value.length - 1];

  mapStore.$patch({
    areaCode: code,
  });

  areaRef.value?.togglePopperVisible();
};
const marks = ref({
  1: "Min",
  10: "10",
  20: "Max",
});

const storagePath = ref("");
const openFolder = async () => {
  const path = await window.electronAPI.selectFolder();
  if (path) {
    storagePath.value = path;
  }
};
</script>
<template>
  <div class="controls">
    <div class="form-item">
      <div class="form-item-header">
        <div class="step-number">1</div>
        <label for="">行政区划</label>
      </div>
      <el-cascader
        ref="areaRef"
        v-model="getAreaCode"
        :options="areaList"
        :props="cascaderProps"
        @change="handleChangeCode"
        placeholder="请选择行政区划"
      />
    </div>
    <div class="form-item">
      <div class="form-item-header">
        <div class="step-number">2</div>
        <label for="">{{ `缩放级别（${zoom[0]} ~ ${zoom[1]}）` }}</label>
      </div>
      <el-slider
        v-model="zoom"
        range
        show-stops
        :max="20"
        :min="1"
        :marks="marks"
      />
    </div>

    <div class="form-item">
      <div class="form-item-header">
        <div class="step-number">3</div>
        <label for="">瓦片存储目录</label>
      </div>
      <el-button id="selectBtn" @click="openFolder">{{
        storagePath || "选择目录"
      }}</el-button>
    </div>
    <el-button @click="downloadTiles" :disabled="isDownloading"
      >开始下载</el-button
    >

    <div v-if="activeJob" class="job-status">
      <h3>下载状态: {{ activeJob.status }}</h3>
      <el-progress
        type="circle"
        :percentage="
          activeJob.tileCount
            ? (activeJob.downloaded * 100) / activeJob.tileCount
            : 100
        "
      />
    </div>
  </div>
</template>
<style scoped>
.controls {
  width: 380px;
  position: absolute;
  right: 0;
  top: 0;
  padding: 20px 20px 20px 30px;
  height: calc(100% - 40px);
  overflow-x: visible;
  overflow-y: auto;
}

.step-number {
  font-weight: 600;
  font-size: 20px;
  background: #322631;
  width: 35px;
  height: 35px;
  text-align: center;
  border-radius: 50%;
  color: white;
  position: relative;
  left: -20px;
  z-index: 1000;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.el-slider {
  margin-top: 0;
}

label {
  margin-bottom: 4px;
  font-weight: 500;
  font-size: 20px;
}

.form-item {
  margin-left: 20px;
  margin-bottom: 25px;
  display: flex;
  flex-direction: column;
}

.form-item-header {
  margin-left: -20px;
  display: flex;
  align-items: center;
}
.job-status {
  margin-top: 20px;
}

.stats {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  font-size: 14px;
}
</style>
